# T1528.Entra.ServicePrincipalAccessTokenTheft

Detect access token theft for Microsoft Entra Service Principals / Workload Identities.

## Hunt Tags

**ID:** T1036.001-Entra-ServicePrincipalAccessTokenTheft

**Author:** [Nicola Suter](https://nicolasuter.ch)

**License:** [MIT License](https://github.com/nicolonsky/ITDR/blob/main/LICENSE)

**References:** [Link to medium post](https://nicolasuter.medium.com)

## ATT&CK Tags

**Tactic:** Credential Access (TA0006)

**Technique:** Steal Application Access Token (T1528)

## Technical description of the attack

In order to evade detection an attacker may use binaries that mimic a trusted certificate or modified signed binaries to make outbound network connections for various reasons. The binary can also be completely unsigned which stands out even more.

## Permission required to execute the technique

Access to the device or service where the service principal is being used, such as a CI/CD pipeline running on GitHub Actions.

## Detection description

By combining the network Microsoft Graph Activity Logs and the SignInEvents towards the difference between IP addresses we have a fairly trustworthy means of detection.

## Utilized Data Source

| Event ID | Event Name                    | Log Provider | ATT&CK Data Source |
| -------- | ----------------------------- | ------------ | ------------------ |
| -        | MicrosoftGraphActivityLogs    | Entra ID     | Cloud Service      |
| -        | AADManagedIdentitySignInLogs  | Entra ID     | Cloud Service      |
| -        | AADServicePrincipalSignInLogs | Entra ID     | Cloud Service      |

## Hunt details

### KQL

**FP Rate:** _Low_

**Source:** _Entra ID_

**Description:** _This detection looks at differences within the IP adresses between the access token issuance and usage._

**Query:**

```kusto
// Hunt for differences between the token issuance and token usage IP address of entra service principals
MicrosoftGraphActivityLogs
| where TimeGenerated > ago(30d)
| where ResponseStatusCode between (100 .. 300 ) // only include success status codes
| lookup kind=inner (
    union AADServicePrincipalSignInLogs, AADManagedIdentitySignInLogs
) on $left.SignInActivityId == $right.UniqueTokenIdentifier
| extend SigninInIPAddress = IPAddress1, ActivityIPAddress = IPAddress
| where SigninInIPAddress != ActivityIPAddress
| project-away *1
| project TimeGenerated, ServicePrincipalName, SigninInIPAddress, ActivityIPAddress, ServicePrincipalId, ServicePrincipalCredentialKeyId, RequestUri, RequestMethod
```

## Considerations

- Only MicrosoftGraphActivityLogs with a corresponding SignIn are considered (due to inner join).

## False Positives

False positives are unlikely but could occur in the following cases:

- Multiple public IP addresses are pooled and used by the same service principal (e.g. NAT gateways).
- The service principal passes the access token to another service principal with a different public IP address.

## Detection Blind Spots

- If there are missing events or the access token is reused within the same Public IP address, this detection will not work.
- The detection only covers the Microsoft Graph API, other APIs are not covered.

## References

- https://learn.microsoft.com/en-us/graph/microsoft-graph-activity-logs-overview
-
